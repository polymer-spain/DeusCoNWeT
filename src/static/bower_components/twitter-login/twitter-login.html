<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
  -->
  <link rel="import" href="../polymer/polymer.html">
  <link rel="import" href="../core-ajax/core-ajax.html">
  <link rel="import" href="../paper-button/paper-button.html">
  <link rel="import" href="../core-icon/core-icon.html">
<!--
Element providing solution to no problem in particular.

##### Example

    <twitter-login></twitter-login>

@element twitter-login
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://polymerlabs.github.io/twitter-login
-->
<polymer-element name="twitter-login" attributes="endpoint">

<template>

  <link rel="stylesheet" href="twitter-login.css">
  <core-ajax
               id="requestToken" url={{endpoint}}
               method="GET"
               params='{
                      "action": "request_token"
                    }'
               handleAs="json"
             on-core-response="{{authentication}}"
             >
  </core-ajax>

  <paper-button id="TwitterButton" on-click="{{login}}">
    <core-icon src='twitter_logo.png' style="width: 24px; height: 24px; background-repeat:no-repeat" ></core-icon>
  Sign in with Twitter
</paper-button>
<content></content>
</template>


<script>

Polymer({

      /**
       * The `sayHello` method will return a greeting.
       *
       * @method sayHello
       * @param {String} greeting Pass in a specific greeting.
       * @return {String} Returns a string greeting.
       */
       endpoint:'',
       login: function(event, detail, sender) {
         this.$.requestToken.go();
      },

      /**
       * The `sayHello` method will return a greeting.
       *
       * @method sayHello
       * @param {String} greeting Pass in a specific greeting.
       * @return {String} Returns a string greeting.
       */
      authentication: function(event, detail, sender) {
        var oauth_url = detail.response.oauth_url;
        var win  = window.open(oauth_url, "Autoriza la aplicacion", 'width=800, height=600');
        var back = this;
        var pollTimer  =  window.setInterval(function() {
          try {
            if(win.document.URL.indexOf('example-project-13') != -1){
              window.clearInterval(pollTimer);
              back.fire('twitter-logged',{token:'',redSocial:'twitter'});
              win.close()
            }
          } catch(e) {
          }
        }, 100);
      }
    });

</script>

</polymer-element>
